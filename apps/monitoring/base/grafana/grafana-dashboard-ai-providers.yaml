apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: ai-providers
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  instanceSelector:
    matchLabels:
      dashboards: "grafana"
  folderRef: gitops
  json: >
    {
      "uid": "ai-providers",
      "title": "OpenAI Usage",
      "schemaVersion": 39,
      "version": 1,
      "refresh": "1m",
      "timezone": "browser",
      "panels": [
        {
          "type": "stat",
          "title": "Exporter Health",
          "datasource": { "type": "prometheus", "uid": "prometheus-user-workload" },
          "description": "Whether the robotheus exporter is running and being scraped by Prometheus. 1 = healthy, 0 = down.",
          "gridPos": { "x": 0, "y": 0, "w": 6, "h": 6 },
          "fieldConfig": {
            "defaults": {
              "mappings": [
                { "type": "value", "options": { "1": { "text": "UP", "color": "green" }, "0": { "text": "DOWN", "color": "red" } } }
              ],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "red", "value": null }, { "color": "green", "value": 1 }] }
            }
          },
          "targets": [
            {
              "refId": "A",
              "expr": "max(up{job=~\".*robotheus.*\"})",
              "instant": true
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "OpenAI Token Throughput",
          "description": "Rate of tokens (input + output combined) consumed across all OpenAI API calls, measured over a 5-minute rolling window.",
          "datasource": { "type": "prometheus", "uid": "prometheus-user-workload" },
          "gridPos": { "x": 6, "y": 0, "w": 18, "h": 9 },
          "fieldConfig": {
            "defaults": { "unit": "tokens/s", "custom": { "fillOpacity": 15 } }
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(robotheus_openai_tokens_total[5m]))",
              "legendFormat": "tokens/s"
            }
          ]
        },
        {
          "type": "stat",
          "title": "Cost Today",
          "description": "Total OpenAI spend (USD) accumulated since midnight UTC, summed across all projects.",
          "datasource": { "type": "prometheus", "uid": "prometheus-user-workload" },
          "gridPos": { "x": 0, "y": 9, "w": 6, "h": 9 },
          "fieldConfig": {
            "defaults": {
              "unit": "currencyUSD",
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 10 }, { "color": "red", "value": 50 }] }
            }
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(increase(robotheus_openai_cost_usd_total[1d]))",
              "instant": true
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "OpenAI Tokens by Project",
          "datasource": { "type": "prometheus", "uid": "prometheus-user-workload" },
          "description": "Token consumption rate broken down by OpenAI project, showing which project is driving the most API usage.",
          "gridPos": { "x": 6, "y": 9, "w": 18, "h": 9 },
          "fieldConfig": {
            "defaults": { "unit": "tokens/s", "custom": { "fillOpacity": 15 } }
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (project_id) (rate(robotheus_openai_tokens_total[5m]))",
              "legendFormat": "{{ project_id }}"
            }
          ]
        }
      ]
    }
